
<section class="container write-blog">
    <div class="heading text-center">
        <h2>{% if model_name == 'article' %}Write an artile or blog{% else %}Start a discussion {% endif %}</h2>
    </div>


    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <form class="blog-form">
            <input data-name="id" type="hidden" value="{{model.id}}">
            <div class="form-group">
                <label for="heading">Title</label>
                <input data-name="title" type="text" data-name="title" class="form-control" placeholder="Enter blog heading" value="{{model.title}}">
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea class="form-control" data-name="description" placeholder="Enter blog description" rows="2">{{model.description}}</textarea>
            </div>

            <div class="form-group">
                {% if model.cover_image %}
                <div class="thumbnail">
                    <a href="#" data-action="write-content-image-upload" title="Click to change"><img data-name="cover-image-display" src="{{model.cover_image_path}}" width="40%"/></a>
                    <div class="caption text-center">Click to change</div>
                </div>
                {% else %}
                <button data-action="write-content-image-upload" class="btn btn-link btn-primary">Upload Cover Image</button>
                {% endif %}
                <input type="hidden" data-name="cover-image" value=""/>
            </div>

            <div class="form-group">
                <label for="content">Content</label>
                <textarea class="form-control summernote" data-name="content" placeholder="Enter blog description" rows="10" >{{model.content}}</textarea>
            </div>

            {% if user and 'Admin' in user.roles %}
            <div class="form-group">
                <label for="channel">Channels</label>
                <select class="form-control" data-name="channels">
                </select>
                <script>
                    $(document).ready(function(){
                        var _channels = '{% for c in model.channels %}{{c.id}}{% if not loop.last %},{% endif %}{% endfor %}';
                        var channels = _channels.split(',');
                        $.ajax({
                            url: '/options?model_name=channel&attr=name&select=1'
                        }).done(function (data) {
                            $('[data-name="channels"]').append(data);
                            for(var i = 0; i < channels.length; i++) {
                                $('[data-name="channels"] option[value="' + channels[i] + '"]').prop('selected', true);
                            }
                        });
                    });
                </script>
            </div>
            {% endif %}

            <div class="form-group">
                <label for="tags">Tags</label>
                <input type="text" class="form-control" data-name="tags" placeholder="Enter Tags" list="tag-list">
                <datalist id="tag-list"></datalist>
                <div class="container">
                    <div id="tags_list" class="fitrangi-tags-list">
                    </div>
                </div>
            </div>


            <button type="button" data-action="go-back" class="btn fitrangi-btn">Back</button>
            <button type="button" data-action="save" class="btn fitrangi-btn">Save as draft</button>
            <button type="button" data-action="publish" class="btn fitrangi-btn">Publish</button>
        </form>
    </div>
</section>



<script>
    $(document).ready(function(){

        var save_content = function(publish){
            var tags = [];

            var $tags = $('[data-tag]');
            if ($tags != undefined && $tags.length > 0) {
                for (var j = 0; j < $tags.length; j++) {
                    tags.push($($tags[j]).attr('data-tag'));
                }
            }

            var channels = null;
            if ($('[data-name="channels"]')){
                channels = $('[data-name="channels"]').val();
            }
            var options = {
                publish: publish,
                id: $('[data-name="id"]').val(),
                title: $('[data-name="title"]').val(),
                description: $('[data-name="description"]').val(),
                content: $('[data-name="content"]').val(),
                cover_image: $('[data-name="cover-image"]').val(),
                channels: channels,
                tags: tags
            };

            console.log(options);
        };


        $('[data-action="publish"]').click(function(e){
            e.stopPropagation();
            e.preventDefault();
            save_content(true);
        });
        $('[data-action="save"]').click(function(e){
            e.stopPropagation();
            e.preventDefault();
            save_content(false);
        });
        $('[data-action="go-back"]').click(function(){
            window.history.back();
        });

        $.ajax({
            url: '/options?model_name=tag&attr=name'
        }).done(function (data) {
            $('#tag-list').append(data);
        });

        var _tags = '{% for c in model.tags %}{{c}}{% if not loop.last %},{% endif %}{% endfor %}';
        var tags = null;
        if (_tags.length > 0) {
           tags = _tags.split(',');
        } else {
           tags = []
        }

        for(var i = 0; i < tags.length; i++)  {
            var tag = tags[i];
            $("#tags_list").append('<a data-tag="'+tag+'" class="remove-tag" href="#">'+tag+'&nbsp;|&nbsp;X</a></span>');
        }

        $('#tags_list').on('click', '.remove-tag', function(e){
            e.preventDefault();
            e.stopPropagation();
            $(e.target).remove();
        });

        $('[data-name="tags"]').keypress(function(e){
            var code = (e.keyCode ? e.keyCode : e.which);
            if(code == 13 || code == 188) { //Enter keycode
                var tag = $('[data-name="tags"]').val();
                $("#tags_list").append('<a  data-tag="'+tag+'" class="remove-tag" href="#">'+tag+'&nbsp;|&nbsp;X</a></span>');
                $('[data-name="tags"]').val('');
                e.preventDefault();
                e.stopPropagation();
            }
        });


        var display = '<div id="form-control-image-uploader"><div class="form-group"><label for="tags">Select Image to upload</label><input data-image="file-uploader" type="file" class="form-control" placeholder="Image selector" ></div></div>';
        $('[data-action="write-content-image-upload"]').click(function(e){
            e.stopPropagation();
            e.preventDefault();
            BootstrapDialog.show({
                title: 'Upload Picture',
                message: display,
                buttons: [
                    {
                        label: 'Close',
                        action: function(dialogRef) {
                            dialogRef.close();
                        }
                    },
                    {
                        label: 'Upload Image',
                        cssClass: 'btn-primary',
                        action: function(dialogRef) {
                            var data = new FormData();
                            jQuery.each($('input[data-image="file-uploader"]')[0].files, function(i, file) {
                                data.append('file-'+i, file);
                                console.log(file);
                            });
                            dialogRef.enableButtons(false);
                            dialogRef.setClosable(false);
                            dialogRef.getModalBody().html('<p>Uploading File.</p><br/><center><img src="/img/loading.gif"></center>');
                            jQuery.ajax({
                                url: '/dialog/upload_image',
                                data: data,
                                cache: false,
                                contentType: false,
                                processData: false,
                                type: 'POST',
                                success: function(data){
                                    $('[data-name="cover-image-display"]').attr('src', data.url);
                                    $('[data-name="cover-image"]').val(data.url);
                                    dialogRef.close();
                                },
                                error: function(data) {
                                    dialogRef.setMessage('Something went wrong when uploading the file.');
                                }
                            });

                        }
                    }
                ]
            });
        });
    });
</script>
